name: Автоочистка с бэкапом

on:
  schedule:
    - cron: "0 2 * * *"  # Каждую ночь в 5:00 МСК
  workflow_dispatch:      # Ручной запуск

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Создать бэкап перед очисткой
        run: |
          DATE=$(date +%Y%m%d)
          cp iptv.m3u8 iptv_backup_$DATE.m3u8
          git add iptv_backup_$DATE.m3u8
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git commit -m "Бэкап перед очисткой ($DATE)" || echo "Бэкап уже существует"
          git push
      
      - name: Запустить очистку
        uses: 4gray/iptv-checker@v1
        with:
          playlist: iptv.m3u8
          output: iptv.m3u8
          timeout: 15
          threads: 3
      
      - name: Сохранить результат и лог удалений
        run: |
          # Считаем, сколько строк было и стало
          OLD=$(grep -c '^http' iptv_backup_$(date +%Y%m%d).m3u8)
          NEW=$(grep -c '^http' iptv.m3u8)
          DELETED=$((OLD - NEW))
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add iptv.m3u8
          git commit -m "Автоочистка: удалены $DELETED каналов (бэкап: iptv_backup_$(date +%Y%m%d).m3u8)" || echo "Нет изменений"
          git push
